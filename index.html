<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioTool</title>
    <style>
        :root {
            --primary-color: #0077b6;
            --secondary-color: #00b4d8;
            --background-color: #f0f8ff;
            --text-color: #03045e;
            --card-front-bg: #ade8f4;
            --card-back-bg: #48cae4;
            --white-color: #ffffff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            box-sizing: border-box;
        }

        h1 {
            color: var(--primary-color);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .container {
            width: 95%;
            max-width: 800px;
            background-color: var(--white-color);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            text-align: center;
        }

        input[type="file"] {
            display: none;
        }

        .custom-file-upload {
            border: 2px dashed var(--secondary-color);
            color: var(--primary-color);
            background-color: #eafcff;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            display: inline-block;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .custom-file-upload:hover {
            background-color: #caf0f8;
            border-color: var(--primary-color);
        }

        #fileName {
            margin-top: 15px;
            font-style: italic;
            color: #555;
        }

        #study-area {
            display: none;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        canvas {
            cursor: pointer;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: transform 0.2s ease;
        }
        
        canvas:hover {
            transform: scale(1.02);
        }

        .navigation {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            gap: 15px;
        }

        .nav-button, .action-button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--white-color);
        }

        .nav-button {
            background-color: var(--secondary-color);
        }

        .nav-button:hover:not(:disabled) {
            background-color: #0096c7;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .nav-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        #stop-button {
            background-color: #d00000;
        }
        #stop-button:hover {
            background-color: #9d0208;
        }
        
        #results-area {
            display: none;
            width: 95%;
            max-width: 800px;
        }

        #results-content {
            background: var(--white-color);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
            max-height: 50vh;
            overflow-y: auto;
        }

        #results-content h3 {
            text-align: center;
            color: var(--primary-color);
        }

        .result-item {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
        }
        .result-item:last-child {
            border-bottom: none;
        }
        .result-item strong {
            color: var(--primary-color);
        }

        .results-actions {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        #download-pdf-button {
            background-color: #4c956c;
        }
        #download-pdf-button:hover {
            background-color: #2c6e49;
        }

        #play-again-button {
            background-color: var(--primary-color);
        }
        #play-again-button:hover {
            background-color: #005f73;
        }

        .loader {
            border: 6px solid #f3f3f3;
            border-top: 6px solid var(--secondary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1.5s linear infinite;
            display: none;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <h1>Biotool 2.0 üß™ Flashcards con IA</h1>

    <div class="container" id="upload-container">
        <label for="pdfFile" class="custom-file-upload">
            Seleccionar archivo PDF
        </label>
        <input type="file" id="pdfFile" accept="application/pdf">
        <p id="fileName">Ning√∫n archivo seleccionado</p>
    </div>

    <div id="loader" class="loader"></div>

    <div id="study-area">
        <canvas id="flashcard-canvas" width="450" height="280"></canvas>
        <div class="navigation">
            <button id="prev-button" class="nav-button">Anterior</button>
            <button id="stop-button" class="nav-button action-button">STOP</button>
            <button id="next-button" class="nav-button">Siguiente</button>
        </div>
    </div>

    <div id="results-area">
        <div class="container">
             <div id="results-content">
                <h3>Resumen de la Sesi√≥n</h3>
                <div id="results-list"></div>
            </div>
            <div class="results-actions">
                <button id="download-pdf-button" class="action-button">Descargar PDF</button>
                <button id="play-again-button" class="action-button">Volver a Jugar</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Setup PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;

        // DOM Elements
        const pdfFileInput = document.getElementById('pdfFile');
        const fileNameDisplay = document.getElementById('fileName');
        const loader = document.getElementById('loader');
        const studyArea = document.getElementById('study-area');
        const resultsArea = document.getElementById('results-area');
        const uploadContainer = document.getElementById('upload-container');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const stopButton = document.getElementById('stop-button');
        const downloadPdfButton = document.getElementById('download-pdf-button');
        const playAgainButton = document.getElementById('play-again-button');
        const resultsList = document.getElementById('results-list');
        
        // Canvas setup
        const canvas = document.getElementById('flashcard-canvas');
        const ctx = canvas.getContext('2d');

        // App state
        let flashcards = [];
        let currentCardIndex = 0;
        let isFlipped = false;

        // Event Listeners
        pdfFileInput.addEventListener('change', handleFileSelect);
        canvas.addEventListener('click', () => {
            isFlipped = !isFlipped;
            drawFlashcard();
        });
        prevButton.addEventListener('click', showPrevCard);
        nextButton.addEventListener('click', showNextCard);
        stopButton.addEventListener('click', stopStudySession);
        downloadPdfButton.addEventListener('click', downloadResultsAsPDF);
        playAgainButton.addEventListener('click', resetUI);

        function resetUI() {
            studyArea.style.display = 'none';
            resultsArea.style.display = 'none';
            uploadContainer.style.display = 'block';
            fileNameDisplay.textContent = 'Ning√∫n archivo seleccionado';
            pdfFileInput.value = ''; // Reset file input
            flashcards = [];
            currentCardIndex = 0;
            isFlipped = false;
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file && file.type === 'application/pdf') {
                resetUI();
                fileNameDisplay.textContent = file.name;
                loader.style.display = 'block';
                uploadContainer.style.display = 'none';
                extractTextFromPdf(file);
            } else {
                alert('Por favor, selecciona un archivo PDF v√°lido.');
            }
        }

        async function extractTextFromPdf(file) {
            try {
                const reader = new FileReader();
                reader.onload = async function() {
                    const typedarray = new Uint8Array(this.result);
                    const pdf = await pdfjsLib.getDocument(typedarray).promise;
                    let textContent = '';
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const text = await page.getTextContent();
                        textContent += text.items.map(s => s.str).join(' ');
                    }
                    // Call the new Gemini-powered function
                    await generateFlashcardsWithGemini(textContent);
                };
                reader.readAsArrayBuffer(file);
            } catch (error) {
                console.error('Error processing PDF:', error);
                alert('Hubo un error al procesar el PDF.');
                resetUI();
            }
        }

        async function generateFlashcardsWithGemini(text) {
            // The API Key will be automatically provided by the environment.
            const apiKey = "AIzaSyCVHPIM7KbzWi3SKkb1lAo0ztGXarlLIeE"; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            // We create a specific prompt to guide the AI.
            const prompt = `
                Eres un tutor experto en bioqu√≠mica. A partir del siguiente texto, extra√≠do de apuntes de un estudiante, 
                genera un m√°ximo de 15 flashcards (preguntas y respuestas).
                Las preguntas deben ser de razonamiento o sobre conceptos clave y dif√≠ciles.
                Las respuestas deben ser cortas, concisas y extra√≠das directamente del texto.
                No inventes informaci√≥n. Si el texto no es claro, no generes la flashcard.

                Texto: "${text.substring(0, 8000)}" 
            `;

            // We define the expected JSON structure for the response.
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "flashcards": {
                                type: "ARRAY",
                                items: {
                                    type: "OBJECT",
                                    properties: {
                                        "question": { "type": "STRING" },
                                        "answer": { "type": "STRING" }
                                    },
                                    required: ["question", "answer"]
                                }
                            }
                        }
                    }
                }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }

                const result = await response.json();
                
                const jsonText = result.candidates[0].content.parts[0].text;
                const parsedJson = JSON.parse(jsonText);
                
                flashcards = parsedJson.flashcards || [];

            } catch (error) {
                console.error("Error calling Gemini API:", error);
                alert("No se pudieron generar las flashcards con la IA. Por favor, int√©ntalo de nuevo.");
                resetUI();
                return;
            }

            loader.style.display = 'none';

            if (flashcards.length > 0) {
                studyArea.style.display = 'flex';
                drawFlashcard();
                updateNavButtons();
            } else {
                alert('La IA no pudo generar flashcards a partir de este texto. Prueba con un documento diferente.');
                resetUI();
            }
        }

        function drawFlashcard() {
            const card = flashcards[currentCardIndex];
            if (!card) return;

            const content = isFlipped ? card.answer : card.question;
            const bgColor = isFlipped ? 'var(--card-back-bg)' : 'var(--card-front-bg)';
            const textColor = isFlipped ? 'var(--white-color)' : 'var(--text-color)';

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue(bgColor.substring(4, bgColor.length - 1)).trim();
            ctx.beginPath();
            ctx.moveTo(15, 0);
            ctx.lineTo(canvas.width - 15, 0);
            ctx.quadraticCurveTo(canvas.width, 0, canvas.width, 15);
            ctx.lineTo(canvas.width, canvas.height - 15);
            ctx.quadraticCurveTo(canvas.width, canvas.height, canvas.width - 15, canvas.height);
            ctx.lineTo(15, canvas.height);
            ctx.quadraticCurveTo(0, canvas.height, 0, canvas.height - 15);
            ctx.lineTo(0, 15);
            ctx.quadraticCurveTo(0, 0, 15, 0);
            ctx.closePath();
            ctx.fill();

            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue(textColor.substring(4, textColor.length - 1)).trim();
            ctx.font = '18px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            wrapText(ctx, content, canvas.width / 2, canvas.height / 2, canvas.width - 50, 22);
        }

        function wrapText(context, text, x, y, maxWidth, lineHeight) {
            const words = text.split(' ');
            let line = '';
            let lines = [];

            for (let n = 0; n < words.length; n++) {
                const testLine = line + words[n] + ' ';
                const metrics = context.measureText(testLine);
                if (metrics.width > maxWidth && n > 0) {
                    lines.push(line);
                    line = words[n] + ' ';
                } else {
                    line = testLine;
                }
            }
            lines.push(line);

            const totalTextHeight = (lines.length - 1) * lineHeight;
            const startY = y - (totalTextHeight / 2);

            for (let i = 0; i < lines.length; i++) {
                context.fillText(lines[i].trim(), x, startY + i * lineHeight);
            }
        }

        function updateNavButtons() {
            prevButton.disabled = currentCardIndex === 0;
            nextButton.disabled = currentCardIndex === flashcards.length - 1;
        }

        function showPrevCard() {
            if (currentCardIndex > 0) {
                currentCardIndex--;
                isFlipped = false;
                drawFlashcard();
                updateNavButtons();
            }
        }

        function showNextCard() {
            if (currentCardIndex < flashcards.length - 1) {
                currentCardIndex++;
                isFlipped = false;
                drawFlashcard();
                updateNavButtons();
            }
        }

        function stopStudySession() {
            studyArea.style.display = 'none';
            resultsArea.style.display = 'block';
            
            resultsList.innerHTML = '';
            const viewedCards = flashcards.slice(0, currentCardIndex + 1);
            
            if (viewedCards.length === 0) {
                 resultsList.innerHTML = '<p>No se ha repasado ninguna tarjeta.</p>';
                 return;
            }

            viewedCards.forEach((card, index) => {
                const item = document.createElement('div');
                item.className = 'result-item';
                item.innerHTML = `
                    <p><strong>Pregunta ${index + 1}:</strong> ${card.question}</p>
                    <p><strong>Respuesta:</strong> ${card.answer}</p>
                `;
                resultsList.appendChild(item);
            });
        }

        function downloadResultsAsPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const viewedCards = flashcards.slice(0, currentCardIndex + 1);
            
            let y = 15;
            const pageHeight = doc.internal.pageSize.height;
            const margin = 10;

            doc.setFontSize(18);
            doc.text("Resumen de Flashcards - Biotool", 105, y, { align: 'center' });
            y += 15;

            viewedCards.forEach((card, index) => {
                if (y > pageHeight - 30) {
                    doc.addPage();
                    y = 15;
                }
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                const questionLines = doc.splitTextToSize(`Pregunta ${index + 1}: ${card.question}`, 180);
                doc.text(questionLines, margin, y);
                y += (questionLines.length * 5) + 2;

                doc.setFont(undefined, 'normal');
                const answerLines = doc.splitTextToSize(`Respuesta: ${card.answer}`, 180);
                doc.text(answerLines, margin, y);
                y += (answerLines.length * 5) + 10;
            });

            doc.save('biotool-flashcards.pdf');
        }
    </script>
</body>
</html>


